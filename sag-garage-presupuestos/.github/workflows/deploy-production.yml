name: 'SAG Garage - Deploy Production'

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy Production to SAG Garage Server

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ”¨ Build production
      run: npm run build

    - name: ğŸ“ List build files
      run: |
        echo "ğŸ“‚ Files in dist directory:"
        ls -la dist/
        echo "ğŸ“„ Content of dist/index.html:"
        head -20 dist/index.html

    - name: ğŸŒ Deploy frontend via FTP (Clean Deploy)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./dist/
        server-dir: /public_html/n3wv3r510nh1dd3n/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**

    - name: ğŸ”§ Deploy .htaccess for frontend
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./frontend-htaccess/
        server-dir: /public_html/n3wv3r510nh1dd3n/
        exclude: |
          **/.git*
          **/.git*/**

    - name: ğŸ”§ Deploy backend-php (Clean Deploy)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./backend-php/
        server-dir: /public_html/backend-php/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**
          **/.env

    - name: âœ… Deploy Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Deploy Production Successful!"
        echo "ğŸŒ Frontend: https://saggarage.com.mx/n3wv3r510nh1dd3n/"
        echo "ğŸ”§ Backend: https://saggarage.com.mx/backend-php/"

    - name: âŒ Deploy Failed Notification
      if: failure()
      run: |
        echo "ğŸ’¥ Deploy Production Failed!"
        echo "ğŸ”§ Check build process and FTP credentials"