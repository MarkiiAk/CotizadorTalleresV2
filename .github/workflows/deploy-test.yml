name: 'Cotizador Talleres - Deploy to cPanel'

on:
  push:
    branches: [ master ]
    paths:
      - 'sag-garage-presupuestos/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar el c√≥digo del repositorio
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      # 2. Configurar Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: sag-garage-presupuestos/package-lock.json

      # 3. Instalar dependencias
      - name: üì¶ Instalar dependencias
        working-directory: sag-garage-presupuestos
        run: npm ci

      # 4. Configurar environment de producci√≥n
      - name: üîß Configurar environment de producci√≥n
        working-directory: sag-garage-presupuestos
        run: cp .env.production .env

      # 5. Compilar el proyecto React
      - name: üèóÔ∏è Build proyecto React
        working-directory: sag-garage-presupuestos
        run: npm run build
        env:
          NODE_ENV: production

      # 6. Verificar que el build se cre√≥ correctamente
      - name: ‚úÖ Verificar build
        run: |
          if [ ! -d "sag-garage-presupuestos/dist" ]; then
            echo "‚ùå Error: La carpeta dist no se gener√≥"
            exit 1
          fi
          echo "‚úÖ Build generado correctamente"
          ls -la sag-garage-presupuestos/dist/

      # 7. Preparar estructura de deploy
      - name: üì¶ Preparar estructura de deploy
        run: |
          echo "üìÅ Creando estructura de deploy..."
          mkdir -p deploy-temp
          
          # Copiar sitio p√∫blico (public-site) a la ra√≠z
          echo "üìÑ Copiando sitio p√∫blico completo..."
          cp sag-garage-presupuestos/public-site/index.html deploy-temp/
          cp sag-garage-presupuestos/public-site/logo.jpg deploy-temp/ 2>/dev/null || true
          cp sag-garage-presupuestos/public-site/logo.png deploy-temp/ 2>/dev/null || true
          cp sag-garage-presupuestos/public-site/DatosBancarios.jpeg deploy-temp/ 2>/dev/null || true
          cp sag-garage-presupuestos/public-site/ManualCorporativo.pdf deploy-temp/ 2>/dev/null || true
          cp -r sag-garage-presupuestos/public-site/css deploy-temp/ 2>/dev/null || true
          cp -r sag-garage-presupuestos/public-site/js deploy-temp/ 2>/dev/null || true
          cp -r sag-garage-presupuestos/public-site/img deploy-temp/ 2>/dev/null || true
          
          # Copiar .htaccess de public-site
          echo "‚öôÔ∏è Copiando .htaccess ra√≠z..."
          cp sag-garage-presupuestos/public-site/.htaccess deploy-temp/ 2>/dev/null || true
          
          # Copiar la aplicaci√≥n React a la carpeta n3wv3r510nh1dd3n/
          echo "‚öõÔ∏è  Copiando aplicaci√≥n React..."
          cp -r sag-garage-presupuestos/dist deploy-temp/n3wv3r510nh1dd3n
          
          # Copiar create-user.html espec√≠ficamente
          echo "üë§ Copiando create-user.html..."
          cp sag-garage-presupuestos/n3wv3r510nh1dd3n/create-user.html deploy-temp/n3wv3r510nh1dd3n/ 2>/dev/null || true
          
          echo "‚úÖ Estructura preparada:"
          ls -la deploy-temp/
          echo ""
          echo "üìÇ Contenido de n3wv3r510nh1dd3n/:"
          ls -la deploy-temp/n3wv3r510nh1dd3n/

      # 8. Subir sitio p√∫blico a ra√≠z de cPanel
      - name: üöÄ Deploy sitio p√∫blico a ra√≠z
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir solo el sitio p√∫blico a la ra√≠z
          local-dir: deploy-temp/
          server-dir: ./
          
          dangerous-clean-slate: false
          
          exclude: |
            **/n3wv3r510nh1dd3n/**
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
          
          security: strict
          timeout: 600000

      # 9. Subir aplicaci√≥n React a carpeta /n3wv3r510nh1dd3n/
      - name: üöÄ Deploy aplicaci√≥n React a /n3wv3r510nh1dd3n/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir contenido de n3wv3r510nh1dd3n/ a la carpeta remota
          local-dir: deploy-temp/n3wv3r510nh1dd3n/
          server-dir: ./n3wv3r510nh1dd3n/
          
          dangerous-clean-slate: false
          
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
            **/backend-php/**
          
          security: strict
          timeout: 600000

      # 10. Subir Backend PHP a /n3wv3r510nh1dd3n/backend-php/
      - name: üêò Deploy Backend PHP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          # Subir backend PHP
          local-dir: sag-garage-presupuestos/backend-php/
          server-dir: ./n3wv3r510nh1dd3n/backend-php/
          
          dangerous-clean-slate: true
          
          exclude: |
            **/.git
            **/.github/**
            **/.gitignore
            **/node_modules/**
            **/.vscode/**
            **/.DS_Store
            **/.env
            **/.env.example
          
          log-level: verbose
          security: loose
          timeout: 900000

      # 11. Configurar .env de producci√≥n
      - name: üîß Configurar .env de producci√≥n
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          local-dir: sag-garage-presupuestos/backend-php/
          server-dir: ./n3wv3r510nh1dd3n/backend-php/
          
          dangerous-clean-slate: false
          
          # Solo subir .env.production como .env
          exclude: |
            **/*
            !**/.env.production
          
          log-level: verbose
          security: loose
          timeout: 300000

      # 12. Subir .htaccess del frontend para React Router
      - name: üìÑ Upload frontend .htaccess
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          
          local-dir: sag-garage-presupuestos/frontend-htaccess/
          server-dir: ./n3wv3r510nh1dd3n/
          
          dangerous-clean-slate: false
          
          exclude: |
            **/*
            !**/.htaccess
          
          log-level: verbose
          security: loose
          timeout: 300000

      # 13. Notificaci√≥n de √©xito
      - name: ‚úÖ Deploy completado
        if: success()
        run: |
          echo "üéâ ¬°Deploy exitoso a cPanel!"
          echo "ÔøΩ Frontend: https://saggarage.com.mx/n3wv3r510nh1dd3n/"
          echo "üîß Backend: https://saggarage.com.mx/n3wv3r510nh1dd3n/backend-php/"
          echo "ÔøΩüè† Sitio p√∫blico: https://saggarage.com.mx/"
          echo "‚è∞ Fecha: $(date)"

      # 14. Notificaci√≥n de error
      - name: ‚ùå Deploy fall√≥
        if: failure()
        run: |
          echo "‚ùå Hubo un error en el deploy"
          echo "Revisa los logs arriba para m√°s detalles"