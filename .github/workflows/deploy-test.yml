name: 'Cotizador Talleres - Deploy Production'

on:
  push:
    branches: [ master ]
    paths:
      - 'sag-garage-presupuestos/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no changes detected'
        required: false
        default: 'false'

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy Cotizador Talleres to Production Server

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: sag-garage-presupuestos/package-lock.json

    - name: ğŸ“¦ Install dependencies
      working-directory: sag-garage-presupuestos
      run: npm ci

    - name: ğŸ—ï¸ Build production frontend
      working-directory: sag-garage-presupuestos
      run: npm run build

    - name: ğŸ” Verify build and setup production env
      run: |
        echo "âœ… Build completed. Contents of dist:"
        ls -la sag-garage-presupuestos/dist/
        echo "ğŸ”§ Setting up production environment..."
        cp sag-garage-presupuestos/backend-php/.env.production sag-garage-presupuestos/backend-php/.env
        echo "âœ… Production .env configured with NUEVA BASE saggarag_CotizadorTalleres"
        echo "ğŸ“ Frontend build ready in dist/ folder"

    - name: ğŸŒ Deploy frontend build via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./sag-garage-presupuestos/dist/
        server-dir: /n3wv3r510nh1dd3n/
        exclude: |
          **/.git*
          **/.git*/**

    - name: ğŸ”§ Deploy .htaccess for frontend
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./sag-garage-presupuestos/frontend-htaccess/
        server-dir: /n3wv3r510nh1dd3n/
        exclude: |
          **/.git*
          **/.git*/**

    - name: ğŸ”§ Deploy backend-php
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./sag-garage-presupuestos/backend-php/
        server-dir: /n3wv3r510nh1dd3n/backend-php/
        exclude: |
          **/.git*
          **/.git*/**
          **/.env

    - name: âœ… Deploy Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Deploy Complete - Cotizador Talleres Ready!"
        echo "ğŸ“¡ Files uploaded to: ftp.saggarage.com.mx/public_html/n3wv3r510nh1dd3n/"
        echo "ğŸŒ Frontend App: https://saggarage.com.mx/n3wv3r510nh1dd3n/"
        echo "ğŸ”§ Backend API: https://saggarage.com.mx/n3wv3r510nh1dd3n/backend-php/"
        echo "âœ… NUEVA BASE: saggarag_CotizadorTalleres"

    - name: âŒ Deploy Failed Notification
      if: failure()
      run: |
        echo "ğŸ’¥ Deploy Test Failed!"
        echo "ğŸ”§ Check FTP credentials and server connection"